<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<title>报名模板管理</title>
		<link rel="stylesheet" type="text/css" href="../bootstrap-3.3.7-dist/css/bootstrap.min.css"/>
		<style type="text/css">
			#rs-wrap{margin: 6%;}
			.drag-item{position: absolute;width:360px;opacity: .8;}
			.placeholder{position:relative;border: 2px dashed rgba(0,188,255,.6);}
			.slot-item , .rs-baoliu{padding-right:45px;line-height: 1;cursor: pointer;font-size: 0;}
			.rs-baoliu{background-color: #eee;}
			.slot-item .rs-itemName,.slot-item .rs-itemRule,
			.rs-baoliu .rs-itemName,.rs-baoliu .rs-itemRule{
				display:inline-block;width: 50%;font-size: 14px;
			}
			.slot-item .glyphicon , .rs-baoliu .glyphicon{
				position: absolute;top: 0;right: 0;padding: 10px 15px;font-size: 14px;
				transition: background-color .3s;
				-moz-transition: background-color .3s;
				-webkit-transition: background-color .3s;
				-o-transition: background-color .3s;
			}
			.slot-item .glyphicon:hover{background-color: rgba(0,188,255,.6);}
			.btn-group-justified .glyphicon{top: 3px;}
			.modal-body .input-group{margin: 10px;}
		</style>
	</head>
	<body>
		<div id="rs-wrap">
			<div class="panel panel-default">
				<div class="panel-heading">报名字段管理</div>
				<div class="panel-body row">
					<div class="col-md-offset-1 col-md-2 col-xs-offset-0 col-xs-12">
						<div class="list-group row">
							<div class="col-md-12 col-xs-3">
								<button type="button" class="list-group-item">中学报名表字段（辖区内）</button>
							</div>
							<div class="col-md-12 col-xs-3">
								<button type="button" class="list-group-item">中学报名表字段（辖区外）</button>
							</div>
							<div class="col-md-12 col-xs-3">
								<button type="button" class="list-group-item">小学报名表字段（辖区内）</button>
							</div>
							<div class="col-md-12 col-xs-3">
								<button type="button" class="list-group-item">小学报名表字段（辖区外）</button>
							</div>
						</div>
					</div>
					<div class="col-md-offset-0 col-md-8 col-xs-offset-1 col-xs-10">
						<div class="btn-group btn-group-justified" role="group">
							<div class="btn-group" role="group">
								<button id="rs-up" type="button" data-toggle="modal" data-target="#uploadModal" class="btn btn-default btn-info btn-lg">
									<span class="glyphicon glyphicon-download" aria-hidden="true"></span>
									上传报名表
								</button>
							</div>
							<div class="btn-group" role="group">
								<button id="rs-down" type="button" class="btn btn-default btn-info btn-lg">
									<span class="glyphicon glyphicon-upload" aria-hidden="true"></span>
									下载报名表
								</button>
							</div>
						</div>
						<button id="rs-saveItem" type="button" class="btn btn-warning btn-block hidden">保存</button>
						<ul class="list-group text-center" style="margin-bottom: 0px;">
							<li class="list-group-item rs-baoliu">
								<span class="rs-itemName">姓名1</span>
								<span id="rule4" class="rs-itemRule">仅汉字</span>
								<span class="glyphicon glyphicon-ban-circle pull-right" aria-hidden="true"></span>
							</li>
							<li class="list-group-item rs-baoliu">
								<span class="rs-itemName">姓名2</span>
								<span id="rule4" class="rs-itemRule">仅汉字</span>
								<span class="glyphicon glyphicon-ban-circle pull-right" aria-hidden="true"></span>
							</li>
							<li class="list-group-item rs-baoliu">
								<span class="rs-itemName">姓名3</span>
								<span id="rule4" class="rs-itemRule">仅汉字</span>
								<span class="glyphicon glyphicon-ban-circle pull-right" aria-hidden="true"></span>
							</li>
						</ul>
						<div id="dragslot" class="slot">
							<ul id="slot-list" class="list-group slot-list text-center" style="margin-bottom: 0px;">
								<li class="list-group-item slot-item">
									<span id='i1' class="rs-itemName">姓名</span>
									<span id="rule4" class="rs-itemRule">仅汉字</span>
									<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span>
								</li>
								<li class="list-group-item slot-item">
									<span id='' class="rs-itemName">性别</span>
									<span id="rule1" class="rs-itemRule">无</span>
									<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span>
								</li>
								<li class="list-group-item slot-item">
									<span id='i2' class="rs-itemName">民族</span>
									<span id="rule1" class="rs-itemRule">无</span>
									<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span>
								</li>
								<li class="list-group-item slot-item">
									<span id='i3' class="rs-itemName">身份证号</span>
									<span id="rule8" class="rs-itemRule">身份证号（18位数字）</span>
									<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span>
								</li>
								<li class="list-group-item slot-item">
									<span class="rs-itemName">报名学校</span>
									<span id="rule1" class="rs-itemRule">无</span>
									<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span>
								</li>
								<li class="list-group-item slot-item">
									<span class="rs-itemName">入学前幼儿园</span>
									<span id="rule1" class="rs-itemRule">无</span>
									<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span>
								</li>
								<li class="list-group-item slot-item">
									<span class="rs-itemName">家庭地址</span>
									<span id="rule1" class="rs-itemRule">无</span>
									<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span>
								</li>
								<li class="list-group-item slot-item">
									<span class="rs-itemName">所在居委会</span>
									<span id="rule1" class="rs-itemRule">无</span>
									<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span>
								</li>
								<li class="list-group-item slot-item">
									<span class="rs-itemName">学生类型</span>
									<span id="rule1" class="rs-itemRule">无</span>
									<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span>
								</li>
							</ul>
						</div>
						<div class="input-group">
							<div class="input-group-addon">添加报名表字段名</div>
							<input id="rs-addItemText" type="text" class="form-control">
							<span class="input-group-btn">
								<button id="rs-addItem" class="btn btn-default" type="button">
									<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
									添加
								</button>
							</span>
						</div>
					</div>
				</div>
				<!--<div class="panel-footer clearfix"></div>-->
			</div>
		</div>
		<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel">
			<div class="modal-dialog modal-sm" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="uploadModalLabel">上传表格</h4>
					</div>
					<div class="modal-body">
						<input type="file" class="form-control">
					</div>
		    		<div class="modal-footer">
		    			<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
		    			<button type="button" id="rs-modalUp" class="btn btn-primary">上传</button>
		    		</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel">
			<div class="modal-dialog modal-sm" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="editModalLabel">编辑字段名</h4>
					</div>
					<div class="modal-body">
					    <div class="input-group">
							<div class="input-group-addon">字段名称</div>
							<input type="text" id="rs-modalText" class="form-control">
						</div>
						<div class="input-group">
							<div class="input-group-addon">内容填写规则</div>
							<select id="rs-modalSelect" class="form-control">
								<option value="rule1">无</option>
								<option value="rule2">非空</option>
								<option value="rule3">仅数字</option>
								<option value="rule4">仅汉字</option>
								<option value="rule5">邮箱格式</option>
								<option value="rule6">日期格式</option>
								<option value="rule7">手机号（11位数字）</option>
								<option value="rule8">身份证号（18位数字）</option>
							</select>
						</div>
					</div>
		    		<div class="modal-footer">
		    			<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
		    			<button type="button" id="rs-modalDelete" class="btn btn-danger">删除</button>
		    			<button type="button" id="rs-modalEdit" class="btn btn-primary">更改</button>
		    		</div>
				</div>
			</div>
		</div>
		<script src="../js/jquery-3.0.0.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../bootstrap-3.3.7-dist/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/dragslot.js" type="text/javascript" charset="utf-8"></script>
		<script>
			function setDisabled(){
				//这个类是用来设置报名期间的上传、删除、添加不可用。
				$('#rs-up').prop("disabled",true);
				$('#rs-modalDelete').prop("disabled",true);
				$('#rs-addItemText').prop("disabled",true);
				$('#rs-addItem').prop("disabled",true);
			}
			function itemListfunc(){
				//获取当前页面上字段名列表中的值
				var itemList = [];
				$('.slot-item').each(function(){
					itemList.push($.trim($(this).children('.rs-itemName').text()));
				});
				$('.rs-baoliu').each(function(){
					itemList.push($.trim($(this).children('.rs-itemName').text()));
				});
//				console.log("itemList的类型为：" + typeof(itemList) + "\nitemList的长度为："+itemList.length + "\nitemList的值为："+itemList);
				return itemList;
			}
			(function(){
				var slotItem , slotItemTxt , slotItemTxtRule;
				$('#slot-list').on('mousedown','.slot-item .glyphicon',function(e){
					e.stopImmediatePropagation();
					slotItem = $(this).parent();
					slotItemTxt = slotItem.children('.rs-itemName');
					slotItemTxtRule =  slotItem.children('.rs-itemRule');
					$('#editModal').modal('show');
					//设置模态框中文本
					$('#rs-modalText').val($.trim(slotItemTxt.text()));
					$('#rs-modalSelect').val(slotItemTxtRule.attr('id'));
				});
				//点击删除，删除此节点
				$('#rs-modalDelete').click(function (e){
					if(!slotItem){alert('操作失败,请刷新');return;}
					slotItem.remove();
					$('#editModal').modal('hide');
					$('#rs-down').prop("disabled",true);
					$('#rs-saveItem').removeClass("hidden");
				});
				//点击修改，修改此节点值
				$('#rs-modalEdit').click(function (e){
					if(!slotItem){alert('操作失败,请刷新');return;}
					//获取修改文本框内的文本
					var editText = $('#rs-modalText').val();
					//获取修改规则框内的文本
					var editRule = $('#rs-modalSelect option:selected').text();
					//获取修改规则的值
					var editRuleId = $('#rs-modalSelect option:selected').val();
					var itemList = [];
					itemList = itemListfunc();
					var isInArray = $.inArray(editText,itemList);
					var itemIndex = $('#slot-list').children().index(slotItem);
					//console.log(isInArray+'+++'+itemIndex);
					if(isInArray != -1 && isInArray != itemIndex){alert("已存在此字段名。");return;}
					slotItemTxt.text(editText);
					slotItemTxtRule.text(editRule);
					slotItemTxtRule.attr('id',editRuleId);
					$('#editModal').modal('hide');
					$('#rs-down').prop("disabled",true);
					$('#rs-saveItem').removeClass("hidden");
				});
			})();
			//点击添加
			$('#rs-addItem').click(function(){
				//addId的'items'为字段序号////////////////////
				var addId = 'items' + ($('.slot-item').length + 1);
				var addText = $.trim($('#rs-addItemText').val());
				var itemList = [];
				if(addText == ''){return;}
				itemList = itemListfunc();
				if($.inArray(addText,itemList) != -1){alert("已存在此字段名。");return;}
				if($('.slot-item').length >= 40){alert("字段数量过多，无法添加。");return;}
				//缺少一套对添加字段的校验
				$('#slot-list').append('<li class="list-group-item slot-item">'+
					'<span id='+addId+' class="rs-itemName">'+addText+'</span>'+
					'<span id="rule1" class="rs-itemRule">无</span>'+
					'<span class="glyphicon glyphicon-edit pull-right" aria-hidden="true"></span></li>');
				$('#rs-addItemText').val('');
				$('#rs-down').prop("disabled",true);
				$('#rs-saveItem').removeClass("hidden");
			});
			//点击保存
			$('#rs-saveItem').click(function(){
				//ToWhere是设置post路径的变量
				var ToWhere = $('.container').attr('id');
				var itemList = [];
				$('.slot-item').each(function(){
					//字段名的id值
					var nameId = $(this).children('.rs-itemName').attr('id');
					//字段名值
					var nameTxt = $.trim($(this).children('.rs-itemName').text());
					//字段名规则id值
					var ruleId = $.trim($(this).children('.rs-itemRule').attr('id'));
					itemList.push(nameId + ':' + nameTxt + ':' + ruleId);
				});
				console.log(itemList);
//				console.log("itemList的类型为：" + typeof(itemList) + "\nitemList的长度为："+itemList.length + "\nitemList的值为："+itemList);
				$('#rs-saveItem').addClass("hidden");
				$('#rs-down').prop("disabled",false);
				//通过Ajax提交信息到后台
//				$.ajax({
//					contentType: "application/x-www-form-urlencoded; charset=UTF-8", 
//					type: "POST",
//					url: "",/*地址*/
//					data: {itemList : JSON.stringify(itemList)},/*传参*/
//					dataType: "json",
//					success: function(data){
//						$('#rs-saveItem').addClass("hidden");
//					},
//					error: function(jqXHR){alert(jqXHR.status);}
//				});
			});
			jQuery(function($){
				$('#dragslot').dragslot({
					dropCallback: function(el){/*alert(el);*/}
				});
			});
		</script>
	</body>
</html>